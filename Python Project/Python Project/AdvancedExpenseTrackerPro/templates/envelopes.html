{% extends "base.html" %}

{% block title %}Envelopes{% endblock %}

{% block content %}
<div class="card">
    <h2>Budget Envelopes</h2>
    <button onclick="showAddModal()" style="margin-bottom: 15px;">Create Envelope</button>

    {% if envelopes %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
        {% for env in envelopes %}
        <div class="card" style="{% if env.spent > env.allocated %}border: 2px solid #f44336; background-color: #fee;{% elif env.is_pooled %}border: 2px solid #9c27b0; background-color: #f3e5f5;{% endif %}">
            <h3>{{ env.name }}{% if env.is_pooled %} <span style="background-color: #9c27b0; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">Pooled</span>{% endif %}</h3>
            <div style="margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Allocated:</span>
                    <strong>₹{{ "%.2f"|format(env.allocated) }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Spent:</span>
                    <strong style="color: #f44336;">₹{{ "%.2f"|format(env.spent) }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Remaining:</span>
                    <strong style="color: #4CAF50;">₹{{ "%.2f"|format(env.allocated - env.spent) }}</strong>
                </div>
                {% if env.allocated > 0 %}
                {% set percentage = (env.spent / env.allocated * 100)|int %}
                {% if percentage > 100 %}{% set display_percentage = 100 %}{% else %}{% set display_percentage = percentage %}{% endif %}
                <div style="background-color: #ddd; height: 10px; border-radius: 5px; overflow: hidden;">
                    <div style="background-color: {% if percentage > 100 %}#f44336{% elif percentage > 80 %}#ff9800{% else %}#4CAF50{% endif %}; height: 100%; width: {{ display_percentage }}%;"></div>
                </div>
                {% endif %}
                {% if env.allocated > 0 and env.spent > env.allocated %}
                <p style="color: #f44336; margin-top: 5px; font-size: 12px;">⚠️ Overspent by ₹{{ "%.2f"|format(env.spent - env.allocated) }}</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-center">No envelopes yet. Create your first envelope.</p>
    {% endif %}
</div>

<!-- Add Envelope Modal -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Create Envelope</div>
        <form method="POST" action="{{ url_for('add_envelope') }}">
            <div class="form-group">
                <label>Name</label>
                <input type="text" name="name" required>
            </div>
            <div class="form-group">
                <label>Allocated Amount</label>
                <input type="number" name="allocated" step="0.01" required>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="is_pooled">
                    Pooled Envelope (shared across categories)
                </label>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="hideAddModal()" class="btn-secondary">Cancel</button>
                <button type="submit">Create</button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddModal() {
    document.getElementById('addModal').style.display = 'block';
}
function hideAddModal() {
    document.getElementById('addModal').style.display = 'none';
}
window.onclick = function(event) {
    var modal = document.getElementById('addModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}
</script>
{% endblock %}
