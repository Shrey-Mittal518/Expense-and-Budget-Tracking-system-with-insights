{% extends "base.html" %}

{% block title %}Goals{% endblock %}

{% block content %}
<!-- Congratulations Modal -->
<div id="congratsModal" class="modal" style="display: none;">
    <div class="modal-content" style="text-align: center; max-width: 500px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
        <div style="font-size: 100px; margin: 20px 0;">üéâ</div>
        <h2 style="color: white; margin-bottom: 10px; font-size: 32px;">Congratulations!</h2>
        <p style="font-size: 20px; margin-bottom: 30px; opacity: 0.95;">You've completed your savings goal!</p>
        <div style="font-size: 60px; margin: 20px 0;">üèÜ</div>
        <button onclick="hideCongratsModal()" style="width: 100%; background-color: white; color: #667eea; font-weight: bold; font-size: 18px;">Awesome!</button>
    </div>
</div>

<div class="card">
    <h2>Savings Goals</h2>
    <button onclick="showAddModal()" style="margin-bottom: 15px;">Create Goal</button>

    {% if goals %}
    <div style="display: grid; gap: 20px;">
        {% for goal in goals %}
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <h3>{{ goal.name }}</h3>
                    {% if goal.deadline %}
                    <p style="font-size: 14px; color: #666;">Target Date: {{ goal.deadline }}</p>
                    {% endif %}
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-size: 24px; font-weight: bold; color: #4CAF50;">
                        {{ "%.0f"|format((goal.current / goal.target * 100)) }}%
                    </span>
                    <form method="POST" action="{{ url_for('delete_goal', goal_id=goal.id) }}" style="margin: 0;" onsubmit="return confirm('Are you sure you want to delete this goal?');">
                        <button type="submit" class="delete-btn" title="Delete goal">üóëÔ∏è</button>
                    </form>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Current:</span>
                    <strong>‚Çπ{{ "%.2f"|format(goal.current) }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Target:</span>
                    <strong>‚Çπ{{ "%.2f"|format(goal.target) }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Remaining:</span>
                    <strong style="color: #4CAF50;">‚Çπ{{ "%.2f"|format(goal.target - goal.current) }}</strong>
                </div>
                {% if goal.target > 0 %}
                {% set goal_percentage = (goal.current / goal.target * 100)|int %}
                {% if goal_percentage > 100 %}
                    {% set display_goal_percentage = 100 %}
                {% else %}
                    {% set display_goal_percentage = goal_percentage %}
                {% endif %}
                <div class="goal-progress-container">
                    <div class="goal-progress-bar" style="--progress-width: {{ display_goal_percentage }}"></div>
                </div>
                {% endif %}
                <button onclick="showContributeModal(this)" data-goal-id="{{ goal.id }}" data-goal-name="{{ goal.name }}" style="width: 100%;">Contribute</button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-center">No goals yet. Create your first savings goal.</p>
    {% endif %}
</div>

<!-- Add Goal Modal -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Create Goal</div>
        <form method="POST" action="{{ url_for('add_goal') }}">
            <div class="form-group">
                <label>Goal Name</label>
                <input type="text" name="name" required>
            </div>
            <div class="form-group">
                <label>Target Amount</label>
                <input type="number" name="target" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Deadline (optional)</label>
                <input type="date" name="deadline">
            </div>
            <div class="modal-footer">
                <button type="button" onclick="hideAddModal()" class="btn-secondary">Cancel</button>
                <button type="submit">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Contribute to Goal Modal -->
<div id="contributeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Contribute to <span id="goalName"></span></div>
        <form method="POST" action="{{ url_for('contribute_to_goal') }}">
            <input type="hidden" name="goal_id" id="goalId">
            <div class="form-group">
                <label>Amount to Contribute</label>
                <input type="number" name="amount" step="0.01" min="0.01" required>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="hideContributeModal()" class="btn-secondary">Cancel</button>
                <button type="submit">Contribute</button>
            </div>
        </form>
    </div>
</div>

<style>
.goal-progress-container {
    background-color: #ddd;
    height: 15px;
    border-radius: 5px;
    overflow: hidden;
    margin-bottom: 10px;
}
.goal-progress-bar {
    background-color: #4CAF50;
    height: 100%;
    width: calc(var(--progress-width) * 1%);
}
.delete-btn {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
    opacity: 0.6;
    transition: all 0.2s;
}
.delete-btn:hover {
    opacity: 1;
    transform: scale(1.2);
}
#congratsModal .modal-content {
    animation: celebrateIn 0.5s ease-out;
}
@keyframes celebrateIn {
    0% {
        transform: scale(0.5) rotate(-5deg);
        opacity: 0;
    }
    50% {
        transform: scale(1.1) rotate(5deg);
    }
    100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
    }
}
</style>

<script>
function showAddModal() {
    document.getElementById('addModal').style.display = 'block';
}
function hideAddModal() {
    document.getElementById('addModal').style.display = 'none';
}
function showContributeModal(button) {
    var goalId = button.getAttribute('data-goal-id');
    var goalName = button.getAttribute('data-goal-name');
    document.getElementById('goalId').value = goalId;
    document.getElementById('goalName').textContent = goalName;
    document.getElementById('contributeModal').style.display = 'block';
}
function hideContributeModal() {
    document.getElementById('contributeModal').style.display = 'none';
}
function showCongratsModal() {
    document.getElementById('congratsModal').style.display = 'block';
}
function hideCongratsModal() {
    document.getElementById('congratsModal').style.display = 'none';
}
window.onclick = function(event) {
    var addModal = document.getElementById('addModal');
    var contributeModal = document.getElementById('contributeModal');
    var congratsModal = document.getElementById('congratsModal');
    if (event.target == addModal) {
        addModal.style.display = 'none';
    }
    if (event.target == contributeModal) {
        contributeModal.style.display = 'none';
    }
    if (event.target == congratsModal) {
        congratsModal.style.display = 'none';
    }
}

// Check for goal completion message and show modal
document.addEventListener('DOMContentLoaded', function() {
    var completedMsg = document.querySelector('.message-goal_completed');
    if (completedMsg) {
        showCongratsModal();
        // Hide the flash message since we're showing the modal
        completedMsg.style.display = 'none';
    }
});
</script>
{% endblock %}
